
[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    G28
    QUAD_GANTRY_LEVEL
    G28
    ##	Uncomment for for your size printer:
    #--------------------------------------------------------------------
    ##	Uncomment for 250mm build
    #G0 X125 Y125 Z30 F3600
    
    ##	Uncomment for 300 build
    #G0 X150 Y150 Z30 F3600
    
    ##	Uncomment for 350mm build
    G0 X175 Y175 Z30 F3600
    #--------------------------------------------------------------------
   
[gcode_macro PRINT_START]
gcode:    
    {% set bedTemp = params.BED|default(0)|float %}                     ; Get/Set bed temperature
    {% set extTemp = params.EXTRUDER|default(0)|int %}                  ; Get/Set extruder temperature
#    {% set chaTemp = params.CHAMBER|default(0)|float %}                 ; Get/Set chamber temperature
#    {% if params.SOAK != null %}
#        {% set heatSoak = params.SOAK|default(8)|int %}                 ; Get/Set heat soak time
#    {% endif %}
    
    # Dummy console out
    {action_respond_info("bedTemp : " + '%s' % bedTemp)}                ; Bed Temperature
    {action_respond_info("extTemp : " + '%s' % extTemp)}                ; First Layer Temperature
    {action_respond_info("chaTemp : " + '%s' % chaTemp)}                ; Chamber temperature time
#    {action_respond_info("heatSoak: " + '%s' % heatSoak)}               ; Heat Soak time

    # Prepare
    M117 Home & QGL
#    STATUS_HOMING                                   ; Stealthburner light control
    G28                                             ; Home
    STATUS_LEVELING                                 ; Stealthburner light control
    QUAD_GANTRY_LEVEL                               ; Quad Gantry Level
#    STATUS_HOMING                                   ; Stealthburner light control
    G28                                             ; Home
    G1 Z7 F1500                                     ; Move nozzle to clean position plus bucket clearance
    G1 X127 F3000                                   ; Move nozzle over the bucket
  
    # Heat soak
#    M117 Starting Warmup                            ; If the bed is already at the correct target temp, we assume no heat soak is necessary.
#    {% if (heatSoak) <= 0 or (printer.heater_bed.target >= (bedTemp - 20)) %}
#    {% else %}
        M117 Heating for Soak
        M190 S{bedTemp}                             ; Set and wait heated bed temperature
        M117 Starting Soak 
#    {% for timer in range(heatSoak,0,-1) %}         ; Cycle once a minute, so we can send an update to keep octoprint happy, rather than just sleeping for the entire soak
#        M117 Soak: {timer|int}m remaining           
#        M105                                        ; Report Temperatures
#        G4 P60000                                   ; Pause for 1 Minute
#    {% endfor %}
#        M117 Soak Complete
#    {% endif %}

    # Prepare extruder
    M117 Extruder heating
    M109 S{extTemp|int}                             ; M109 heat and wait for extruder it to reach temp

    # Clean nozzle
#    M117 Clean Nozzle                               
#    clean_nozzle                                    ; Cleaning

    # Start print
    STATUS_PRINTING                                 ; Stealthburner light control
    M117 Printing   

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament

    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X125 Y250 F3600            ; park nozzle at rear
    BED_MESH_CLEAR
    
    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0

[gcode_macro LOAD_FILAMENT]
gcode:
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E101 F300 # fast-load
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
gcode:
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E25 F1000 # purge
    G1 E-101 F1500 # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state
